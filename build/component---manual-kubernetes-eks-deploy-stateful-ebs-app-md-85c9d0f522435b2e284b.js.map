{"version":3,"sources":["webpack:///../manual/Kubernetes/EKS-Deploy-Stateful-EBS-App.md"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","alt","src","isMDXComponent"],"mappings":"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","file":"component---manual-kubernetes-eks-deploy-stateful-ebs-app-md-85c9d0f522435b2e284b.js","sourcesContent":["import React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/dennis.okeeffe/Project-Imposter/developer-notes/node_modules/gatsby-theme-docz/src/base/Layout.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"deploying-a-stateful-app\"\n    }}>{`Deploying a stateful app`}</h1>\n    <ul>\n      <li parentName=\"ul\"><a parentName=\"li\" {...{\n          \"href\": \"#deploying-a-stateful-app\"\n        }}>{`Deploying a stateful app`}</a><ul parentName=\"li\">\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#the-app\"\n            }}>{`The app`}</a><ul parentName=\"li\">\n              <li parentName=\"ul\"><a parentName=\"li\" {...{\n                  \"href\": \"#frontend\"\n                }}>{`Frontend`}</a></li>\n              <li parentName=\"ul\"><a parentName=\"li\" {...{\n                  \"href\": \"#backend\"\n                }}>{`Backend`}</a></li>\n            </ul></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#the-ebs-volumes\"\n            }}>{`The EBS Volumes`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#creating-the-namespace\"\n            }}>{`Creating the Namespace`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#creating-the-storage-class\"\n            }}>{`Creating the storage class`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#creating-the-persistent-volume-claim-pvc\"\n            }}>{`Creating the persistent volume claim (PVC)`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#deploying-mysql\"\n            }}>{`Deploying MySQL`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#deployment-vs-statefulset-by-using-storageclass-for-ebs\"\n            }}>{`Deployment vs StatefulSet by using storageclass for EBS`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#wordpress-as-a-deployment\"\n            }}>{`Wordpress as a Deployment`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#wordpress-as-a-stateful-set\"\n            }}>{`Wordpress as a Stateful Set`}</a></li>\n          <li parentName=\"ul\"><a parentName=\"li\" {...{\n              \"href\": \"#cleanup-of-resource\"\n            }}>{`Cleanup of resource`}</a></li>\n        </ul></li>\n    </ul>\n    <h2 {...{\n      \"id\": \"the-app\"\n    }}>{`The app`}</h2>\n    <p><img alt=\"App layout\" src=\"https://res.cloudinary.com/gitgoodclub/image/upload/v1548289711/eks-course/Screen_Shot_2019-01-24_at_11.28.22_am.png\" /></p>\n    <h3 {...{\n      \"id\": \"frontend\"\n    }}>{`Frontend`}</h3>\n    <p>{`Wordpress with:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Persistent volume (EBS) to store HTML`}</li>\n      <li parentName=\"ul\">{`Public facing ELB`}</li>\n    </ul>\n    <h3 {...{\n      \"id\": \"backend\"\n    }}>{`Backend`}</h3>\n    <ul>\n      <li parentName=\"ul\">{`Persistent volume (EBS) to store MySQL data`}</li>\n    </ul>\n    <h2 {...{\n      \"id\": \"the-ebs-volumes\"\n    }}>{`The EBS Volumes`}</h2>\n    <p>{`The EBS volumes are tied to an Availability Zone. Re-created pods can only be started in the AZ of the previous volume.`}</p>\n    <p>{`To properly deploy WordPress, we need a shared volume between all the pods (specific to Wordpress).`}</p>\n    <p>{`We want to deploy our pods in multiple AZ.`}</p>\n    <p>{`Therefore the shared volume MUST BE Amazon EFS (Elastic File System).`}</p>\n    <p>{`For this app, EBS is used to demo how things work for stateful apps that do leverage EBS (like MySQL).`}</p>\n    <h2 {...{\n      \"id\": \"creating-the-namespace\"\n    }}>{`Creating the Namespace`}</h2>\n    <p>{`This is best practice to separate the workloads.`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Separation examples can be project, client, team, environment.`}</li>\n      <li parentName=\"ul\">{`Namespaces can also give resource quotas, access controls etc.`}</li>\n    </ul>\n    <p>{`Let's create our own Wordpress stateful app.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`kubectl create namespace ns-eks-course\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"creating-the-storage-class\"\n    }}>{`Creating the storage class`}</h2>\n    <p>{`We can see there are no storage classes by running the following:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`kubectl get storageClass --all-namespaces\n`}</code></pre>\n    <p>{`We can create the storage class by applying the following YAML file:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yml\"\n      }}>{`# gp2-storage-class.yaml\nkind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: gp2\nprovisioner: kubernetes.io/aws-ebs\nparameters:\n  type: gp2\nreclaimPolicy: Retain\nmountOptions:\n  - debug\n`}</code></pre>\n    <p>{`After applying with `}<inlineCode parentName=\"p\">{`kubectl`}</inlineCode>{`, we will have the EBS class created.`}</p>\n    <p>{`We need to set this to default, which we can do by running `}<inlineCode parentName=\"p\">{`kubectl patch sc gp2 -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}' --namespace=ns-eks-course`}</inlineCode></p>\n    <h2 {...{\n      \"id\": \"creating-the-persistent-volume-claim-pvc\"\n    }}>{`Creating the persistent volume claim (PVC)`}</h2>\n    <p>{`Here we are creating two persistent volume claims for both MySQL and WordPress.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\"\n      }}>{`# pvcs.yml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\n  labels:\n    app: wordpress\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: wp-pv-claim\n  labels:\n    app: wordpress\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n`}</code></pre>\n    <p>{`After applying with `}<inlineCode parentName=\"p\">{`kubectl apply -f pvcs.yaml --namespace=ns-eks-course`}</inlineCode>{`, we can see the pvcs there running `}<inlineCode parentName=\"p\">{`kubectl get pvc --namespace=<NS>`}</inlineCode>{`.`}</p>\n    <h2 {...{\n      \"id\": \"deploying-mysql\"\n    }}>{`Deploying MySQL`}</h2>\n    <p>{`First we need to create a secret. We can just pass a literal secret by running `}<inlineCode parentName=\"p\">{`kubectl create secret generic mysql-pass --from-literal=password=password --namespace=ns-eks-course`}</inlineCode>{`.`}</p>\n    <p>{`We can deploy SQL with the following:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yml\"\n      }}>{`# mysql.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress-mysql\n  labels:\n    app: wordpress\nspec:\n  ports:\n    - port: 3306\n  selector:\n    app: wordpress\n    tier: mysql\n  # Ensures no dedicated cluster IP and to remain private\n  clusterIP: None\n---\napiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2\nkind: Deployment\nmetadata:\n  name: wordpress-mysql\n  labels:\n    app: wordpress\nspec:\n  selector:\n    matchLabels:\n      app: wordpress\n      tier: mysql\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: wordpress\n        tier: mysql\n    spec:\n      containers:\n        - image: mysql:5.6\n          name: mysql\n          env:\n            - name: MYSQL_ROOT_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-pass\n                  key: password\n          ports:\n            - containerPort: 3306\n              name: mysql\n          volumeMounts:\n            - name: mysql-persistent-storage\n              mountPath: /var/lib/mysql\n      volumes:\n        - name: mysql-persistent-storage\n          persistentVolumeClaim:\n            claimName: mysql-pv-claim\n`}</code></pre>\n    <p>{`Apply the file and we should get what we want:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`kubectl get pods\n# NAME                              READY   STATUS              RESTARTS   AGE\n# wordpress-mysql-565494758-9p4zm   0/1     ContainerCreating   0          13s\n`}</code></pre>\n    <p>{`Using the dashboard or AWS console, we should now be able to confirm after the pod is ready that the volume has successfully attached to the pod.`}</p>\n    <h2 {...{\n      \"id\": \"deployment-vs-statefulset-by-using-storageclass-for-ebs\"\n    }}>{`Deployment vs StatefulSet by using storageclass for EBS`}</h2>\n    <p>{`One of the issues we face is that if we deploy with EBS, the EBS volume will at most attach only to one node. This is very important to understand!`}</p>\n    <p>{`As for a `}<inlineCode parentName=\"p\">{`StatefulSet`}</inlineCode>{` with an EBS volume, it is used to `}<strong parentName=\"p\">{`attach to a pod`}</strong>{` (used for things like ZooKeeper, Kafka etc).`}</p>\n    <h2 {...{\n      \"id\": \"wordpress-as-a-deployment\"\n    }}>{`Wordpress as a Deployment`}</h2>\n    <p>{`We will launch the Wordpress app as a `}<inlineCode parentName=\"p\">{`Deployment`}</inlineCode>{`, and what that means is that each pod launched will refer to the same Persistent Volume!`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yml\"\n      }}>{`# deploy-wordpress-as-deployment.yml\napiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress\n  labels:\n    app: wordpress\nspec:\n  ports:\n    - port: 80\n  selector:\n    app: wordpress\n    tier: frontend\n  type: LoadBalancer\n---\napiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2\nkind: Deployment\nmetadata:\n  name: wordpress\n  labels:\n    app: wordpress\nspec:\n  selector:\n    matchLabels:\n      app: wordpress\n      tier: frontend\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: wordpress\n        tier: frontend\n    spec:\n      containers:\n        - image: wordpress:4.8-apache\n          name: wordpress\n          env:\n            - name: WORDPRESS_DB_HOST\n              value: wordpress-mysql\n            - name: WORDPRESS_DB_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-pass\n                  key: password\n          ports:\n            - containerPort: 80\n              name: wordpress\n          volumeMounts:\n            - name: wordpress-persistent-storage\n              mountPath: /var/www/html\n      volumes:\n        - name: wordpress-persistent-storage\n          persistentVolumeClaim:\n            claimName: wp-pv-claim\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"wordpress-as-a-stateful-set\"\n    }}>{`Wordpress as a Stateful Set`}</h2>\n    <p>{`In this case for understanding Stateful Sets, we can use this example to show each pod deploying with it's own PVC. In the case of WordPress, this would be an issue given that an image uploaded to one pod would not be available to another -- but this is for the sake of demonstration.`}</p>\n    <p>{`Ensure you always go for a stateful set when it is the right choice (Zookeeper etc). Remember - WordPress is `}<strong parentName=\"p\">{`NOT`}</strong>{` that.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yml\"\n      }}>{`apiVersion: v1\nkind: Service\nmetadata:\n  name: wordpress-statefulset\n  labels:\n    app: wordpress-statefulset\nspec:\n  ports:\n    - port: 80\n  selector:\n    app: wordpress-statefulset\n    tier: frontend\n  type: LoadBalancer\n---\napiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2\nkind: StatefulSet\nmetadata:\n  name: wordpress-statefulset\n  labels:\n    app: wordpress-statefulset\nspec:\n  selector:\n    matchLabels:\n      app: wordpress-statefulset\n      tier: frontend\n  replicas: 1\n  serviceName: wordpress-statefulset-frontend\n  template:\n    metadata:\n      labels:\n        app: wordpress-statefulset\n        tier: frontend\n    spec:\n      containers:\n        - image: wordpress:4.8-apache\n          name: wordpress\n          env:\n            - name: WORDPRESS_DB_HOST\n              value: wordpress-mysql\n            - name: WORDPRESS_DB_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-pass\n                  key: password\n          volumeMounts:\n            - name: wordpress-persistent-storage\n              mountPath: /var/www/html\n          ports:\n            - containerPort: 80\n              name: wordpress\n  volumeClaimTemplates:\n    - metadata:\n        name: wordpress-persistent-storage\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 10Gi\n        storageClassName: gp2\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"cleanup-of-resource\"\n    }}>{`Cleanup of resource`}</h2>\n    <p>{`To delete all the frontend, the backend and the EBS volumes resources, run the applicable kubectl delete on all of the yaml files we have used. This should includes deployments, pods, secrets, pvcs etc.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-yaml\"\n      }}>{`kubectl delete -f NAME.yaml --namespace=ns-course\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}