{"version":3,"sources":["webpack:///../manual/Nodejs/Enhancing-Node-Performance.md"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"mappings":"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","file":"component---manual-nodejs-enhancing-node-performance-md-cca0e1bcb9bff2659805.js","sourcesContent":["import React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/dennis.okeeffe/Project-Imposter/developer-notes/node_modules/gatsby-theme-docz/src/base/Layout.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"enhancing-nodejs-performance\"\n    }}>{`Enhancing Nodejs Performance`}</h1>\n    <p>{`We're going to look at two ways to improve performance:`}</p>\n    <ol>\n      <li parentName=\"ol\">{`Using Node in 'Cluster' Mode`}</li>\n      <li parentName=\"ol\">{`Using Worker Threads`}</li>\n    </ol>\n    <p>{`The recommended approach would be using `}<inlineCode parentName=\"p\">{`cluster`}</inlineCode>{` mode, whereas worker threads are way more experimental.`}</p>\n    <h2 {...{\n      \"id\": \"test-app\"\n    }}>{`Test App`}</h2>\n    <p>{`We'll use a tiny express server for playing around.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`// app.js\nconst express = require('express');\nconst app = express();\n\nfunction doWork(duration) {\n  const start = new Date.now();\n  while (Date.now() - start < duration) {\n    // do nothing else\n  }\n}\n\napp.get('/', (req, res) => {\n  doWork(5000);\n  res.send('Hello');\n});\n\napp.listen(3000);\n`}</code></pre>\n    <p>{`This app will be continually updated to show the performance updates.`}</p>\n    <h2 {...{\n      \"id\": \"blocking-the-event-loop\"\n    }}>{`Blocking the Event Loop`}</h2>\n    <p>{`Keep in mind:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`[Single Thread]\nRequest => Node Server => Response\n`}</code></pre>\n    <p>{`We start to run into issues here when our request requires a lot of processing power (in the example app, this will be the function `}<inlineCode parentName=\"p\">{`doWork`}</inlineCode>{`).`}</p>\n    <p>{`Note that with the `}<inlineCode parentName=\"p\">{`doWork`}</inlineCode>{` function call, we are blocking the entire event loop. `}<strong parentName=\"p\">{`This blocks the entire server from handling other requests.`}</strong></p>\n    <h2 {...{\n      \"id\": \"clustering-in-theory\"\n    }}>{`Clustering in Theory`}</h2>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`Cluster Manager\n  => Single Threaded Node Server\n  => Single Threaded Node Server\n  => Single Threaded Node Server\n`}</code></pre>\n    <p>{`The `}<inlineCode parentName=\"p\">{`cluster manager`}</inlineCode>{` is only responsible for monitoring the health of individual `}<inlineCode parentName=\"p\">{`node server`}</inlineCode>{` instances. It will still be up to the instances to handle the request handling and processing.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`# RUN node app.js\n└── app.js  ===================> Worker Instance\n    └──  Cluster Manager\n        └── cluster.fork() # forks app.js\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"forking-children-with-cluster\"\n    }}>{`Forking Children With Cluster`}</h2>\n    <p>{`When running the manager, note that Node will first run all the JavaScript code in the file and then startup the `}<inlineCode parentName=\"p\">{`Cluster Manager`}</inlineCode>{`. We want to ensure there is at least one scenario with the forked app running as expected.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`// app.js\nconst cluster = require('cluster');\n// Is file executed in the master mode?\nif (cluster.isMaster) {\n  // Cause app.js to be executed again but in child mode\n  cluster.fork();\n} else {\n  // Child - operate as normal server\n  const express = require('express');\n  const app = express();\n\n  function doWork(duration) {\n    const start = new Date.now();\n    while (Date.now() - start < duration) {\n      // do nothing else\n    }\n  }\n\n  app.get('/', (req, res) => {\n    doWork(5000);\n    res.send('Hello');\n  });\n\n  app.listen(3000);\n};\n`}</code></pre>\n    <p>{`If we add multiple `}<inlineCode parentName=\"p\">{`cluster.fork()`}</inlineCode>{` calls, we can have multiple instances of the server ready to run.`}</p>\n    <h2 {...{\n      \"id\": \"benchmarking-server-performance\"\n    }}>{`Benchmarking Server Performance`}</h2>\n    <p>{`For benchmarking, we will use a program called `}<inlineCode parentName=\"p\">{`ab`}</inlineCode>{`. (Available for MacOS)`}</p>\n    <p>{`Usage: `}<inlineCode parentName=\"p\">{`ab -c 50 -n 500 localhost:3000/fast`}</inlineCode>{` where `}<inlineCode parentName=\"p\">{`-c`}</inlineCode>{` is 50 concurrent requests and `}<inlineCode parentName=\"p\">{`-n`}</inlineCode>{` indicates 500 requests.`}</p>\n    <p>{`In the bottom code, we're going show how you can get diminishing returns by adding more children. It is important that we keep a threadpool size of `}<inlineCode parentName=\"p\">{`1`}</inlineCode>{` for this example.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`// app.js\nprocess.env.UV_THREADPOOL_SIZE = 1; // just for benchmarking purposes\nconst cluster = require('cluster');\n// Is file executed in the master mode?\nif (cluster.isMaster) {\n  // Cause app.js to be executed again but in child mode\n  cluster.fork();\n} else {\n  // Child - operate as normal server\n  const crypto = require('crypto');\n  const express = require('express');\n  const app = express();\n  \n  app.get('/', (req, res) => {\n    crypto.pbkdf2('a', 'b', 100000, 512, 'sha512', () => {\n      res.send('Hello');\n    })\n});\n\n  app.listen(3000);\n};\n`}</code></pre>\n    <p>{`If we run `}<inlineCode parentName=\"p\">{`ab -c 1 -n 1 localhost:3000/`}</inlineCode>{` we will see that we get a `}<inlineCode parentName=\"p\">{`Time taken for tests`}</inlineCode>{` to be ~1000ms.`}</p>\n    <p>{`We can see the timing of this is similar to the example for `}<inlineCode parentName=\"p\">{`crypto`}</inlineCode>{` we had in `}<inlineCode parentName=\"p\">{`Nodejs/Node Interals`}</inlineCode>{` when demoing the `}<inlineCode parentName=\"p\">{`crypto`}</inlineCode>{` module.`}</p>\n    <p>{`If we run `}<inlineCode parentName=\"p\">{`ab -c 2 -n 2 localhost:3000/`}</inlineCode>{`, we see that one requests took 1s, while the other took 2s. This is similar to what we saw in `}<inlineCode parentName=\"p\">{`Node Internals`}</inlineCode>{`. Given the one thread, we see that the second request needs to wait for the first request to be released from the threadpool.`}</p>\n    <p>{`If we update our code to add another child process using `}<inlineCode parentName=\"p\">{`cluster.fork();`}</inlineCode>{`, we will notice that both the requests now get processed in the two child processes (STILL USING ONE THREAD) and have come back with the expected time ~1000ms.`}</p>\n    <h3 {...{\n      \"id\": \"what-happens-with-too-many-children\"\n    }}>{`What happens with too many children?`}</h3>\n    <p>{`If we forked six processes and ran `}<inlineCode parentName=\"p\">{`ab -c 6 -n 6 localhost:3000/`}</inlineCode>{` we will see that for some reason, we are now taking 3.5 seconds for each of the 6 requests across the board.`}</p>\n    <p>{`Why is this? It depends on the kind of computer that you have. Note that for the example above, it was run on a dual-core CPU. That's because the CPU is now trying to do a little bit of work on all 6 threads. So although we could now process the children in parallel, we have overallocated our resources.`}</p>\n    <p>{`If we now reduced the forked processes to 2 and still ran `}<inlineCode parentName=\"p\">{`ab -c 6 -n 6 localhost:3000/`}</inlineCode>{`, we will notice that the slowest request is still around 3.4s, while our fastest request is now ~1s. This is because at a cluster with two children, we know that we can at most handle two requests at the same time. `}</p>\n    <p>{`Essentially, the first two requests are processed in the first second, the next two in the second, the last two in the third - this makes perfect sense. This means that we have ended with a far better performance profile.`}</p>\n    <h2 {...{\n      \"id\": \"pm2-configuration\"\n    }}>{`PM2 Configuration`}</h2>\n    <p>{`PM2 can supercharge our clustering setup. PM2 makes cluster management super easy for Nodejs. It can be installed through `}<inlineCode parentName=\"p\">{`npm`}</inlineCode>{` globally using `}<inlineCode parentName=\"p\">{`npm i -g pm2`}</inlineCode>{`.`}</p>\n    <p>{`To run the script in `}<inlineCode parentName=\"p\">{`pm2`}</inlineCode>{`, we need to update our app once again.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`// app.js\n\n// Child - operate as normal server\nconst crypto = require('crypto');\nconst express = require('express');\nconst app = express();\n\napp.get('/', (req, res) => {\n crypto.pbkdf2('a', 'b', 100000, 512, 'sha512', () => {\n   res.send('Hello');\n })\n});\n\napp.listen(3000);\n`}</code></pre>\n    <p><inlineCode parentName=\"p\">{`pm2 start index.js -i 0`}</inlineCode>{` will tell pm2 to auto-configure how many instances to setup based on the amount of logical cores (physical * virtual cores) are available.`}</p>\n    <table>\n      <thead parentName=\"table\">\n        <tr parentName=\"thead\">\n          <th parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Call`}</th>\n          <th parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Definition`}</th>\n        </tr>\n      </thead>\n      <tbody parentName=\"table\">\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`pm2 monit`}</td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Show pm2 monitor`}</td>\n        </tr>\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`pm2 list`}</td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`List all pm2 processes`}</td>\n        </tr>\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`pm2 start index.js -i 0`}</td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Start index.js with auto-configured instances`}</td>\n        </tr>\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`pm2 delete index`}</td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Delete all index children`}</td>\n        </tr>\n      </tbody>\n    </table>\n    <p><inlineCode parentName=\"p\">{`pm2`}</inlineCode>{` is generally used in production environments only.`}</p>\n    <h2 {...{\n      \"id\": \"web-worker-threads\"\n    }}>{`Web Worker Threads`}</h2>\n    <p>{`At the time of writing - these were in experimental phase.`}</p>\n    <p>{`In this example, we are using the module `}<inlineCode parentName=\"p\">{`webworker-threads`}</inlineCode>{`.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-shell\"\n      }}>{`Our App\n└── Worker Interface (communicates with Worker)\n    └── postMessage <===> onmessage (Worker)\n    └── onmessage <===> postMessage (Worker)\n`}</code></pre>\n    <p>{`The `}<inlineCode parentName=\"p\">{`Worker`}</inlineCode>{` itself is working on its own thread. Remember: a lot of the Nodejs standard lib functions ALREADY work on their own thread. You only really want to use it for your own heavy-duty business logic.`}</p>\n    <p>{`Note: any function passed to the worker cannot access the parent scoped variables. It is also important to use the function keyword on purpose.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-javascript\"\n      }}>{`// app.js\nconst Worker = require('webworker-threads').Worker;\nconst express = require('express');\nconst app = express();\n\napp.get('/', (req, res) => {\n  const worker = new Worker(function() {\n    this.onmessage = function() {\n      // emulate heavy work\n      let counter = 0;\n      whilte (counter < 1e9) {\n        counter++;\n      }\n\n      postMessage(counter);\n    }\n  });\n\n  worker.onmessage = function(counter) {\n    console.log(counter);\n    res.send('' + message.data); // casting as send requires string\n  }\n\n  worker.postMessage();\n});\n\napp.listen(3000);\n`}</code></pre>\n    <p>{`For benchmarking these workers, we can again use `}<inlineCode parentName=\"p\">{`ab`}</inlineCode>{`. `}<inlineCode parentName=\"p\">{`ab -c 1 -n 1 localhost:3000/`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`ab -c 2 -n 2 localhost:3000/`}</inlineCode>{` should run with similar results on a dual-core Mac. `}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}